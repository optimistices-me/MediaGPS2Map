<!DOCTYPE html>
<html>
<head>
    <title>照片位置热力图</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
        }

        #map {
            height: 100vh;
            width: 75%; /* 地图占 75% 宽度 */
        }

        #sidebar {
            width: 25%; /* 侧栏占 25% 宽度 */
            padding: 20px;
            background-color: #f4f4f4;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="sidebar">
        <h2>统计信息</h2>
        <p>文件数量: <span id="file-count">0</span></p>
        <p>时间范围: <span id="time-range">无</span></p>
        <p>典型位置:</p>
        <ul id="sample-locations"></ul>
    </div>

    <!-- Leaflet 核心库 -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Leaflet.glify 插件 -->
    <script src="https://unpkg.com/leaflet.glify@2.1.3/dist/leaflet.glify.min.js"></script>

    <!-- Leaflet 核心库 -->
    <script src="{{ url_for('static', filename='js/leaflet.js') }}"></script>
    <!-- Leaflet.glify 插件 -->
    <script src="{{ url_for('static', filename='js/glify-browser.js') }}"></script>

    <script>
        // 初始化地图
        const map = L.map('map').setView([30, 120], 3);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // 更新侧栏信息
        function updateSidebar(data) {
            const fileCount = data.points.length;
            const timestamps = data.points.map(p => new Date(p.timestamp).getTime());
            const minTime = new Date(Math.min(...timestamps)).toLocaleString();
            const maxTime = new Date(Math.max(...timestamps)).toLocaleString();

            document.getElementById('file-count').textContent = fileCount;
            document.getElementById('time-range').textContent = `${minTime} - ${maxTime}`;

            // 显示典型位置
            const sampleLocations = document.getElementById('sample-locations');
            sampleLocations.innerHTML = data.addresses.map(addr => `<li>${addr}</li>`).join('');
        }

        // 获取初始数据
        fetch('/data')
            .then(response => response.json())
            .then(data => {
                console.log('Data received:', data);
                updateSidebar(data); // 更新侧栏信息

                // 将数据转换为 Leaflet.glify 所需的格式
                const points = data.points.map(p => [p.lat, p.lng]);

                // 使用 Leaflet.glify 渲染热图
                L.glify.points({
                    map: map,
                    data: points,
                    color: 'rgba(255, 0, 0, 0.5)', // 红色，50% 透明度
                    size: 5,
                    opacity: 0.8, // 整体透明度
                    fillOpacity: 0.5 // 填充透明度
                });

                // 添加点击事件
                map.on('click', function (e) {
                    const lat = e.latlng.lat;
                    const lng = e.latlng.lng;
                    fetch(`https://restapi.amap.com/v3/geocode/regeo?key=您的API_KEY&location=${lng},${lat}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === '1' && data.regeocode) {
                                const address = data.regeocode.formatted_address;
                                L.popup()
                                    .setLatLng(e.latlng)
                                    .setContent(`<b>地址:</b> ${address}`)
                                    .openOn(map);
                            }
                        });
                });
            })
            .catch(error => console.error('Error:', error));
    </script>
</body>
</html>