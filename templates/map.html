<!DOCTYPE html>
<html>
<head>
    <title>照片位置热力图</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map {
            height: 100vh; /* 确保地图容器有高度 */
            width: 100%;   /* 确保地图容器有宽度 */
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Leaflet 核心库 -->
    <script src="{{ url_for('static', filename='js/leaflet.js') }}"></script>
    <!-- heatmap.js 核心库 -->
    <script src="{{ url_for('static', filename='js/heatmap.min.js') }}"></script>
    <!-- Leaflet.heat 插件 -->
    <script src="{{ url_for('static', filename='js/leaflet-heat.js') }}"></script>

    <script>
        // 检查插件是否加载成功
        if (typeof L.heatLayer === 'function') {
            console.log('Leaflet.heat plugin is loaded successfully!');
        } else {
            console.error('Leaflet.heat plugin is NOT loaded!');
        }

        // 初始化地图
        const map = L.map('map').setView([30, 120], 3);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let heatmapLayer = null;

        // 获取初始数据
        fetch('/data')
            .then(response => response.json())
            .then(data => {
                console.log('Data received:', data);
                const points = data.points.map(p => [p.lat, p.lng]);
                console.log('Points:', points);

                if (points.length === 0) {
                    console.warn('No points found!');
                    return;
                }

                // 创建热图
                if (heatmapLayer) {
                    map.removeLayer(heatmapLayer);
                }
                heatmapLayer = L.heatLayer(points, {
                    radius: 25,      // 热点半径
                    blur: 15,        // 模糊程度
                    maxZoom: 17,     // 最大缩放级别
                    minOpacity: 0.5, // 最小透明度
                    gradient: {      // 颜色渐变
                        0.4: 'blue',
                        0.6: 'lime',
                        0.8: 'yellow',
                        1.0: 'red'
                    }
                }).addTo(map);

                // 调整地图视野范围
                const bounds = L.latLngBounds(points);
                map.fitBounds(bounds);
                console.log('Map bounds:', bounds);
            })
            .catch(error => console.error('Error:', error));
    </script>
</body>
</html>